<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.css" rel="stylesheet" />
		<!--标准mui.css-->
		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/iconfont.css">
		<link rel="stylesheet" href="css/mui.picker.css">
		<link rel="stylesheet" href="css/mui.poppicker.css">
		<link rel="stylesheet" href="css/mui.dtpicker.css">
		<style type="text/css">
			.mui-bar-nav {
				background: #04B1E9;
			}

			.mui-bar-nav a,
			.mui-bar-nav h1 {
				color: #fff;
			}

			.ui-alert {
				text-align: center;
				padding: 20px 10px;
				font-size: 16px;
			}

			.icon-rili {
				float: right;
				width: 15%;
				line-height: 1.1;
				padding: 7px 10px 7px 0px;
				color: #007aff;
			}

			.icon-renwu {
				float: left;
				line-height: 1.1;
				padding: 7px 10px 7px 0px;
				color: #007aff;
			}

			.icon-fujian {
				float: left;
				line-height: 1.1;
				padding: 7px 10px 7px 0px;
				color: #007aff;
			}

			#popover {
				height: 100px;
				width: 200px;
			}
			
			/*toast信息提示*/
			.mui-toast-container {
				bottom: 50% !important;
			}

			.mui-toast-message {
				font-size: 1.5rem;
				opacity: 0.6;
				color: #fff;
				width: auto;
				padding: 20px 20px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">故障管理</h1>
		</header>
		<div class="mui-content">
			<div class="mui-content-padded" style="margin: 5px;">
				<form id="form" class="mui-input-group" enctype="multipart/form-data">
					<div class="mui-input-row">
						<label>编号：</label>
						<input id="fault_number" type="text" placeholder="系统自动生成编号" readonly="readonly">
					</div>
					<div class="mui-input-row">
						<label>名称：</label>
						<input id="fault_name" type="text" class="mui-input-clear" placeholder="请输入故障名称">
					</div>
					<div class="mui-input-row">
						<label>站点名称：</label>
						<input id="stationName" type="text" class="mui-input-clear" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>故障种类：</label>
						<input id="itemCategory" type="text" class="mui-input-clear" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>负责人员：</label>
						<span class="mui-icon iconfont icon-renwu"></span>
						<input id="responsible" style="width: 50%; float: left; padding: 11px 0px;" />
					</div>
					<div class="mui-input-row">
						<label>支持人员：</label>
						<span class="mui-icon iconfont icon-renwu"></span>
						<input id="support" style="width: 50%; float: left; padding: 11px 0px;" />
					</div>
					<div class="mui-input-row">
						<label>开始时间：</label>
						<input id="iStartTime" style="width: 50%; float: left; padding: 11px 0px;" placeholder="1969-01-01" /><span id="startTime"
						 class="mui-icon iconfont icon-rili"></span>
					</div>
					<div class="mui-input-row">
						<label>严重程度：</label>
					</div>
					<div style="background-color: #eee;padding-left: 1rem;">
						<div class="mui-input-row mui-radio mui-left">
							<label>P1</label>
							<input name="level" type="radio" value="P1" checked class="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>P2</label>
							<input name="level" type="radio" value="P2" class="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>P3</label>
							<input name="level" type="radio" value="P3" class="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>P4</label>
							<input name="level" type="radio" value="P4" class="radio">
						</div>
					</div>
					<div class="mui-input-row">
						<label>完成时间：</label>
						<input id="iDoneTime" style="width: 50%; float: left; padding: 11px 0px;" placeholder="1969-01-01" /><span id="doneTime"
						 class="mui-icon iconfont icon-rili"></span>
					</div>
					<div class="mui-input-row">
						<label>进度描述：</label>
					</div>
					<div style="background-color: #eee;padding-left: 1rem;">
						<div class="mui-input-row mui-radio mui-left">
							<label>进行中</label>
							<input name="progress" type="radio" value="进行中" checked class="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>已结束</label>
							<input name="progress" type="radio" value="已结束" class="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>延期</label>
							<input name="progress" type="radio" value="延期" class="radio">
						</div>
					</div>
					<div class="mui-input-row">
						<label>问题描述：</label>
					</div>
					<textarea id="description" rows="5" placeholder="用几句话来描述你的问题"></textarea>
					<div class="mui-input-row">
						<label>附件：</label>
						<input id="enclosure" type="file" name="file" style="margin-top: 5px;" accept="image/gif,image/jpeg,image/x-png"/>
					</div>
					<div class="mui-input-row">
						<label>处理方案：</label>
					</div>
					<textarea id="way" rows="5" placeholder="解决问题的有效方案"></textarea>
					<div class="mui-input-row">
						<label>故障原因分析：</label>
					</div>
					<textarea id="reason" rows="5" placeholder="其他补充"></textarea>
					<div class="mui-input-row">
						<label>备注：</label>
					</div>
					<textarea id="note" rows="5" placeholder="其他补充"></textarea>
					<div class="mui-button-row">
						<button id="submit_btn" type="button" class="mui-btn mui-btn-primary" style="width: 30%; padding: 5px 0; margin-right: 10%;">确认</button>
						<button id="cancel_btn" type="button" class="mui-btn mui-btn-danger" style="width: 30%; padding: 5px 0;">取消</button>
					</div>
				</form>
			</div>
		</div>
		<script src="js/mui.js"></script>
		<script src="js/mui.picker.js"></script>
		<script src="js/mui.poppicker.js"></script>
		<script src="js/mui.dtpicker.js"></script>
		<script src="js/jquery.min.js" type="text/javascript"></script>
		<script>
			mui.init();
			
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				var stationId = self.stationId;
				var stationName = self.stationName;
				var typeId = self.typeId;
				var typeName = self.typeName;
				var timestamp = new Date().getTime();
				var faultNumber = document.getElementById("fault_number");
				faultNumber.value = timestamp;
				$('#stationName').prop("disabled", true);
				$('#itemCategory').prop("disabled", true);
				$("#stationName").val(stationName);
				$("#itemCategory").val(typeName);
				mui.back = function() {
					if ($("#submit_btn").prop("disabled")) {
						mui.currentWebview.close();
					} else {
						mui.confirm('您还没提交，确定离开此页面？', ' ', ['取消', '确认'], function(e) {
							if (e.index == 1) {
								mui.currentWebview.close();
							}
						}, 'div')
					}
				}
				// 滑动触发input失去焦点
				document.querySelector('.mui-content').addEventListener('swipe', function() {
					var input = document.getElementsByTagName("input");
					for (let i = 0; i < input.length; i++) {
						input[i].blur();
					}
				})
				// 滑动触发textarea失去焦点
				document.querySelector('.mui-content').addEventListener('swipe', function() {
					var textarea = document.getElementsByTagName("textarea");
					for (let i = 0; i < textarea.length; i++) {
						textarea[i].blur();
					}
				})
				//开始时间
				$('#iStartTime').prop("disabled", true);
				var Date1 = new mui.DtPicker({
					type: 'datetime'
				});
				var iStartTime = document.getElementById("iStartTime");
				var startTime = document.getElementById("startTime");
				startTime.addEventListener('tap', function() {
					Date1.show(function(item) {
						//日期和日期时间改变一下type值就行 
						iStartTime.value = item.toString();
					})
				});
				//预计结束时间
				$('#iDoneTime').prop("disabled", true);
				var Date2 = new mui.DtPicker({
					type: 'datetime'
				});
				var iDoneTime = document.getElementById("iDoneTime");
				var doneTime = document.getElementById("doneTime");
				doneTime.addEventListener('tap', function() {
					Date2.show(function(item) {
						//日期和日期时间改变一下type值就行 
						iDoneTime.value = item.toString();
					})
				});
				$('#enclosure').on('change', function() {
					changeSubState();
					var filePath = $(this).val();
					if(filePath != '') {
						fileFormat = filePath.substring(filePath.lastIndexOf(".")).toLowerCase();
						// 检查是否是图片
						if (!fileFormat.match(/.png|.jpg|.jpeg/)) {
							alert('上传错误,文件格式必须为：png/jpg/jpeg');
							$("#submit_btn").addClass("mui-disabled");
						}
					}
				})
				function changeSubState() {
					$('#submit_btn').removeClass("mui-disabled");
				}
				var submit_btn = document.getElementById("submit_btn");
				var cancel_btn = document.getElementById("cancel_btn");
				submit_btn.addEventListener('tap', function() {
					var formData = new FormData();
					var img_file = document.getElementById("enclosure");
					var fileObj = img_file.files[0];
					console.log(JSON.stringify(fileObj));
					var userId = plus.storage.getItem('userId');
					var fault_number = $("#fault_number").val();
					var fault_name = $("#fault_name").val();
					var stationName = $("#stationName").val();
					console.log(stationName);
					var itemCategory = $("#itemCategory").val();
					console.log(itemCategory);
					var responsible = $("#responsible").val();
					var support = $("#support").val();
					var iStartTime = $("#iStartTime").val();
					var level = $('input[name="level"]:checked').val();
					var iDoneTime = $("#iDoneTime").val();
					var progress = $('input[name="progress"]:checked').val();
					var description = $("#description").val();
					var way = $("#way").val();
					var reason = $("#reason").val();
					var note = $("#note").val();
					formData.append("userId", userId);
					formData.append("faultNumber", fault_number);
					formData.append("faultTitle", fault_name);
					formData.append("stationName", stationName);
					formData.append("typeName", itemCategory);
					formData.append("responsible", responsible);
					formData.append("support", support);
					formData.append("startTime", iStartTime);
					formData.append("level", level);
					formData.append("doneTime", iDoneTime);
					formData.append("progress", progress);
					formData.append("description", description);
					formData.append("way", way);
					formData.append("reason", reason);
					formData.append("note", note);
					if(fileObj != undefined) {
						formData.append("enclosure", fileObj);
					}
					mui.ajax('http://www.hyfuncloud.cn/api/fault/addFault', {
						data: formData,
						dataType: "json",
						type: 'post',
						async: false,
						processData: false,
						contentType: false,
						timeout: 10000,
						success: function(result) {
							if (result.data == "提交成功") {
								submit_btn.setAttribute("disabled", true);
								mui.toast('提交成功', {
										duration: 'short',
										type: 'div'
									});
							} else {
								mui.toast(JSON.stringify(result.data), {
										duration: 'short',
										type: 'div'
									});
							}
						},
						error: function(xhr, type, errorThrown) {
							mui.toast('错误', {
									duration: 'short',
									type: 'div'
								});
						}
					});
				});
				cancel_btn.addEventListener('tap', function() {
					if ($("#submit_btn").prop("disabled")) {
						mui.currentWebview.close();
					} else {
						mui.confirm('您还没提交，确定离开此页面？', ' ', ['取消', '确认'], function(e) {
							if (e.index == 1) {
								mui.currentWebview.close();
							}
						}, 'div')
					}
				});
			})
		</script>
	</body>

</html>
